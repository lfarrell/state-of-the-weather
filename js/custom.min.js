var margins={top:20,right:50,left:100,bottom:75},parse_date=d3.time.format("%m/%Y").parse,height=400-margins.top-margins.bottom;localStorage.clear();localStorage.setItem("path","all_by_state/US.csv");localStorage.setItem("month","01");localStorage.setItem("state-name","US");
d3.select("#state").on("change",function(){var a=this.options[this.selectedIndex].innerHTML,c=d3.select(this),b=c.property("value"),d="all_by_state/"+b+".csv";localStorage.getItem("month");d3.selectAll(".selected_state").text(a);c.property("value","");localStorage.setItem("path",d);localStorage.setItem("state",b);localStorage.setItem("state-name",a);render()});
d3.select("#month").on("change",function(){var a=this.options[this.selectedIndex].innerHTML,c=d3.select(this),b=c.property("value");localStorage.setItem("month",b);d3.selectAll(".selected_month").text(a);c.property("value","");render()});
var render=_.throttle(function(){d3.selectAll(".charts").classed("hide",!0);d3.selectAll("#load").classed("hide",!1);d3.selectAll(".svg").remove();var a="#543005 #8c510a #bf812d #dfc27d #f6e8c3 #f5f5f5 #c7eae5 #80cdc1 #35978f #01665e #003c30".split(" "),c="#a50026 #d73027 #f46d43 #fdae61 #fee090 #ffffbf #e0f3f8 #abd9e9 #74add1 #4575b4 #313695".split(" ").reverse(),b=localStorage.getItem("path"),d=localStorage.getItem("month"),f=localStorage.getItem("state-name"),p="US"===f?"the "+f:f,e=window.innerWidth-
    100-margins.right-margins.left;d3.csv(b,function(b){function f(a,b,c,d,g){a=d3.select(a).append("svg").attr("width",e+margins.left+margins.right).attr("height",110).attr("class","svg").call(b).selectAll("bar").data(g);a.enter().append("rect");a.attr("x",function(a){return m(parse_date(a.date))}).attr("width",B).attr("y",0).attr("height",80).attr("transform","translate("+margins.left+",0)").style("fill",function(a){return c(d(a.anomaly))}).on("mouseover",function(a){d3.select(this).attr("height",100);
    b.show.call(this,a)}).on("mouseout",function(a){d3.select(this).attr("height",80);b.hide.call(this,a)});return a}b.forEach(function(a){a.date=a.month+"/"+a.year;a.value=+a.value;a.anomaly=+a.anomaly});var l=avgValues(b);_.sortByOrder(b,["year","month"],["asc","asc"]);var g=_.sortByOrder(b,["month","year"],["asc","asc"]),v=dataFilter(g,"drought",d,l),u=dataFilter(g,"max",d,l),h=dataFilter(g,"min",d,l),k=dataFilter(g,"precip",d,l),n=dataFilter(g,"temp",d,l),g=maxMin(v,"value"),w=maxMin(u,"value"),x=
    maxMin(h,"value"),q=maxMin(k,"value"),r=maxMin(n,"value");d3.bisector(function(a){return parse_date(a.date)});var m=d3.time.scale().domain(d3.extent(b,function(a){return parse_date(a.date)})).range([0,e]);yScale(v,height);var z=yScale(u,height),A=yScale(h,height);b=yScale(k,height);var t=yScale(n,height),y=getAxis(m,"bottom"),C=getAxis(z,"left"),D=getAxis(A,"left"),E=getAxis(b,"left"),F=getAxis(t,"left"),B=barWidth(e,k);d3.selectAll(".selected-month").text(stringDate(d));d3.selectAll(".selected-state").text(p);
    var G=stripColors(c);d3.select("#hottest").text(r.max[4].value);d3.select("#hottest-year").text(r.max[4].year);r=showAxises("#temps_div","#avg_temp_line",e,y,F,"Avg. Temperature (F)");t=lineGenerator(m,t,"value");r.append("path").attr("id","temp_line").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",2).attr("transform","translate("+margins.left+","+margins.top+")");d3.select("#temp_line").transition().duration(1E3).ease("sin-in-out").attr("d",t(n));r=stripScale(n,"anomaly");t=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+stringDate(d)+"("+a.year+")</h4><p>Historical Avg: "+monthAvg(l,"temp",d)+" degrees</p><p>Actual Avg: "+a.value+" degrees</p><p>Departure from Avg: "+a.anomaly+" degrees</p>"});f("#temps_div",t,G,r,n);d3.select("#maxtemp").text(w.max[4].value);d3.select("#maxtemp-year").text(w.max[4].year);n=showAxises("#max_div","#max_temp",e,y,C,"Avg. Max. Temperature (F)");w=lineGenerator(m,z,"value");n.append("path").attr("id","max_line").attr("fill",
        "none").attr("stroke","firebrick").attr("stroke-width",2).attr("transform","translate("+margins.left+","+margins.top+")");d3.select("#max_line").transition().duration(1E3).ease("sin-in-out").attr("d",w(u));d3.select("#mintemp").text(x.max[4].value);d3.select("#mintemp-year").text(x.max[4].year);u=showAxises("#min_div","#min_temp",e,y,D,"Avg. Min. Temperature (F)");x=lineGenerator(m,A,"value");u.append("path").attr("id","min_line").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",
        2).attr("transform","translate("+margins.left+","+margins.top+")");d3.select("#min_line").transition().duration(1E3).ease("sin-in-out").attr("d",x(h));d3.select("#wettest").text(q.max[4].value);d3.select("#wettest-year").text(q.max[4].year);h=showAxises("#precip_div","#avg_precip",e,y,E,"Avg. Precipitation (Inches)");q=lineGenerator(m,b,"value");b=lineGenerator(m,b,"mean");h.append("path").attr("id","precip_line").attr("fill","none").attr("stroke","steelblue").attr("stroke-width",2).attr("transform",
        "translate("+margins.left+","+margins.top+")");d3.select("#precip_line").transition().duration(1E3).ease("sin-in-out").attr("d",q(k));h.append("path").attr("id","precip_avg_line").attr("fill","none").attr("stroke","yellow").attr("stroke-width",2).attr("transform","translate("+margins.left+","+margins.top+")");d3.select("#precip_avg_line").transition().duration(1E3).ease("sin-in-out").attr("d",b(k));h=stripColors(a);b=stripScale(k,"anomaly");q=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+
        stringDate(d)+" ("+a.year+")</h4><p>Historical Avg: "+monthAvg(l,"precip",d)+" inches</p><p>Departure from Avg: "+a.anomaly+" inches</p>"});f("#precip_div",q,h,b,k);d3.select("#driest").text(g.min[0].value);d3.select("#driest-year").text(g.min[0].year);k=stripScale(v,"anomaly");g=d3.tip().attr("class","d3-tip").html(function(a){return'<h4 class="text-center">'+stringDate(d)+" ("+a.year+")</h4><p>Historical Avg: "+monthAvg(l,"drought",d)+"</p><p>Departure from Avg: "+a.anomaly+"</p>"});f("#drought_div",
        g,h,k,v);d3.selectAll(".row").classed("hide",!1);d3.selectAll("#load").classed("hide",!0)})},200);function dataFilter(a,c,b,d){a=a.filter(function(a){return b?a.type===c&&a.month===b:a.type===c});b&&a.forEach(function(a){a.mean=monthAvg(d,c,b)});return a}function monthAvg(a,c,b){return a[c][parseInt(b,10)-1].value.toFixed(1)}
function avgValues(a){var c=d3.range(1,13),b={drought:[],max:[],min:[],precip:[],temp:[]},d,f;["drought","max","min","precip","temp"].forEach(function(p){c.forEach(function(c){c=10>c?"0"+c:""+c;d=_.findWhere(a,{month:c,type:p});f=d.value-d.anomaly;b[p].push({key:c,value:f})})});return b}function maxMin(a,c){var b=_.sortBy(a,c),d=b.slice(0,5),b=b.slice(-5);return{min:d,max:b}}function barWidth(a,c){return _.floor(a/c.length,3)}
function yScale(a,c){return d3.scale.linear().range([0,c]).domain([d3.max(a,function(a){return a.value}),0])}function yScaleAnomaly(a,c){return d3.scale.linear().domain(d3.extent(a,function(a){return a.anomaly})).range([0,c])}function stripColors(a){return d3.scale.quantize().domain(d3.range(0,1,1/(a.length-1))).range(a)}function stripScale(a,c){return d3.scale.linear().domain(d3.extent(a,function(a){return a[c]})).range([0,1])}function getAxis(a,c){return d3.svg.axis().scale(a).orient(c)}
function showAxises(a,c,b,d,f,p){var e=d3.select(a).append("svg");e.attr("width",b+margins.left+margins.right).attr("height",height+margins.top+margins.bottom).attr("id",c).attr("class","svg");e.append("g").attr("class","x axis").attr("transform","translate("+margins.left+","+(height+margins.top)+")");d3.selectAll(a+" g.x").call(d);e.append("g").attr("class","y axis").attr("transform","translate("+margins.left+","+margins.top+")");d3.selectAll(a+" g.y").call(f);e.append("text").attr("transform","rotate(-90)").attr("x",
    -height/3).attr("y",6).attr("dy","3.71em").style("text-anchor","end").text(p);return e}function lineGenerator(a,c,b){return d3.svg.line().interpolate("monotone").x(function(b){return a(parse_date(b.date))}).y(function(a){return c(a[b])})}function stringDate(a){return"January February March April May June July August September October November December".split(" ")[parseInt(a,10)-1]}
function createFocus(a){a=a.append("g").attr("class","focus").style("display","none");a.append("circle").attr("class","y0").attr("r",4.5);a.append("line").attr("x1");a.append("text").attr("class","y0").attr("x",9).attr("dy",".35em");return a}render();window.addEventListener("resize",render);